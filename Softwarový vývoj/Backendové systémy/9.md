# 9. Dokumentové nerelační databáze

## Základní principy

**Dokumentové nerelační databáze**

**Definice:**

NoSQL databáze ukládající data jako dokumenty (JSON, BSON, XML), nikoliv v tabulkách s pevným schématem

**Klíčové charakteristiky:**

* **Schema-less** - flexibilní struktura bez pevného schématu
* **Dokumenty** - základní jednotka pro ukládání dat
* **Vnořené struktury** - podporují vnořené objekty a pole
* **Horizontální škálovatelnost** - snadné rozšíření na více serverů

**Výhody:**

* Flexibilita struktury dat
* Rychlý vývoj a prototypování
* Přirozené mapování na objekty v programovacích jazycích
* Vysoký výkon při čtení

**Nevýhody:**

* Slabší podpora pro komplexní relace
* Možná redundance dat
* Větší spotřeba paměti
* Složitější migrace schématu

**Příklady:** MongoDB, CouchDB, Amazon DocumentDB, Azure Cosmos DB

## Dokumenty a kolekce

**Dokumenty a kolekce v NoSQL**

**Dokument:**

* Základní jednotka pro ukládání dat
* Formát: JSON, BSON (Binary JSON), XML
* Může obsahovat vnořené objekty, pole, různé datové typy
* Každý dokument má unikátní identifikátor (\_id)

**Kolekce:**

* Skupina dokumentů (obdoba tabulky v relačních DB)
* Dokumenty v kolekci mohou mít různou strukturu
* Neexistuje pevné schéma
* Možnost indexování na úrovni kolekce

**Struktura dokumentu (příklad):**

`{`

`"_id": ObjectId("..."),`

`"name": "Jan Novák",`

`"email": "jan@example.com",`

`"addresses": [`

`{"type": "home", "city": "Praha"},`

`{"type": "work", "city": "Brno"}`

`]`

`}`

**Výhody:**

* Intuitivní reprezentace objektů
* Flexibilita struktury
* Atomic operace na úrovni dokumentu

## Indexy a optimalizace

**Indexy v dokumentových databázích**

**Typy indexů:**

* **Single Field Index** - index na jedno pole
* **Compound Index** - index na více polí
* **Multikey Index** - automatický index na pole obsahující array
* **Text Index** - fulltextové vyhledávání
* **Geospatial Index** - geografické dotazy

**Optimalizace výkonu:**

* **Explain Plans** - analýza provádění dotazů
* **Covering Index** - index obsahuje všechna potřebná data
* **Index Intersection** - kombinace více indexů
* **Partial Index** - index pouze na část dokumentů

**Best practices:**

* Indexovat často dotazovaná pole
* Omezit počet indexů (zpomalují zápisy)
* Sledovat velikost indexů
* Regular index maintenance

**MongoDB příklad:**

`db.users.createIndex({email: 1})`

`db.users.createIndex({name: 1, age: -1})`

`db.users.createIndex({location: "2dsphere"})`

## Dotazování a agregace

**Dotazování v dokumentových databázích**

**Základní dotazy:**

* **Find** - vyhledávání dokumentů podle kritérií
* **Filter** - filtrování podle hodnot polí
* **Projection** - výběr konkrétních polí
* **Sort** - řazení výsledků
* **Limit & Skip** - stránkování

**Aggregation Pipeline:**

* **$match** - filtrování dokumentů
* **$group** - seskupování a výpočty
* **$sort** - řazení
* **$project** - transformace struktury
* **$lookup** - join s jinou kolekcí
* **$unwind** - rozložení pole na dokumenty

**MongoDB příklady:**

`db.products.find({price: {$gt: 100}})`

`db.orders.aggregate([`

`{$match: {status: "completed"}},`

`{$group: {_id: "$customerId", total: {$sum: "$amount"}}}`

`])`

**Výhody:**

* Expresivní dotazovací jazyk
* Podpora pro komplexní agregace
* Optimalizované pro JSON struktury

## Horizontální škálování

**Horizontální škálování (Sharding)**

**Sharding:**

* Rozdělení dat napříč více servery
* Každý shard obsahuje část dat
* **Shard key** - pole určující rozdělení
* Automatické vyvažování dat mezi shardy

**Komponenty:**

* **Shards** - servery s daty (replica sets)
* **Config servers** - metadata o rozložení dat
* **Mongos** - router směřující dotazy

**Strategie shardingu:**

* **Range-based** - podle rozsahu hodnot
* **Hash-based** - podle hash funkce
* **Zone-based** - geografické rozdělení

**Výhody:**

* Teoreticky neomezená škálovatelnost
* Lepší performance pro velké datasety
* Geografická distribuce

**Nevýhody:**

* Složitost konfigurace a správy
* Hotspot problémy při špatném shard key
* Omezení cross-shard operací
* Rebalancing overhead

**Příklad:** MongoDB sharded cluster s 3 shardy, každý jako 3-node replica set

## Replikace a vysoká dostupnost

**Replikace a vysoká dostupnost**

**Replica Sets:**

* **Primary node** - přijímá zápisy
* **Secondary nodes** - repliky pro čtení
* **Arbiter** - účastní se voleb, neukládá data
* Automatické failover při výpadku primary

**Consistency modely:**

* **Strong consistency** - čtení z primary
* **Eventual consistency** - čtení z secondary (může být zastaralé)
* **Read preference** - primary, secondary, nearest

**Write concern:**

* **w: 1** - potvrzení od primary
* **w: majority** - potvrzení od většiny nodes
* **j: true** - zápis do journal (durabilita)

**Výhody replikace:**

* Vysoká dostupnost (99.99%+)
* Automatické recovery
* Čtení z geograficky blízkých nodes
* Backup bez downtime

**Monitoring:**

* Replication lag
* Oplog size a utilization
* Member health status

**Příklad MongoDB replica set:**

3 nodes: 1 primary + 2 secondary, automatic failover < 30 seconds

## Výkon a monitoring

**Výkon a monitoring dokumentových databází**

**Performance metriky:**

* **Operations/sec** - počet operací za sekundu
* **Query response time** - doba odezvy dotazů
* **Index hit ratio** - efektivita indexů
* **Memory usage** - využití paměti
* **Disk I/O** - čtení/zápis na disk

**Optimalizace výkonu:**

* **Index tuning** - optimalizace indexů
* **Query optimization** - efektivní dotazy
* **Connection pooling** - sdílení spojení
* **Read/Write separation** - čtení z replica
* **Caching** - Redis, Memcached

**Monitoring nástroje:**

* **MongoDB Compass** - GUI nástroj
* **MongoDB Atlas** - cloud monitoring
* **Prometheus + Grafana** - open source
* **Datadog, New Relic** - komerční

**Klíčové alerting:**

* High query response time
* Replication lag
* Disk space utilization
* Memory pressure
* Connection count limits

**Best practices:**

* Regular performance testing
* Proactive capacity planning
* Automated backup verification

## Use cases a porovnání

**Use cases a porovnání s relačními databázemi**

**Ideální use cases pro dokumentové DB:**

* **Content management** - různorodé obsahové struktury
* **E-commerce katalogy** - produkty s různými atributy
* **User profiles** - flexibilní uživatelské profily
* **IoT data** - sensor data s proměnnou strukturou
* **Real-time analytics** - rychlé čtení a agregace

**Kdy nepoužívat:**

* Komplexní transakce napříč entitami
* Silně normalizovaná data
* Časté join operace
* Přísná ACID compliance

**Porovnání s SQL:**

* **Flexibilita schématu:** NoSQL ✓ vs SQL ✗
* **ACID transakce:** NoSQL ✗ vs SQL ✓
* **Horizontální škálování:** NoSQL ✓ vs SQL ✗
* **Query složitost:** NoSQL ✗ vs SQL ✓
* **Learning curve:** NoSQL ✓ vs SQL ✗

**Hybridní přístupy:**

* Polyglot persistence - kombinace více typů databází
* SQL databáze s JSON podporou (PostgreSQL, MySQL 8.0)
* Multi-model databáze (ArangoDB, CosmosDB)

**Rozhodovací faktory:**

Struktura dat, výkon, škálovatelnost, konzistence, developer experience
