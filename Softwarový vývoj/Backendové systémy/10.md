# 10. MongoDB

## Úvod a představení

**MongoDB - NoSQL dokumentová databáze**

**Charakteristiky:**

* **Dokumentově orientovaná** - ukládá data ve formátu BSON (Binary JSON)
* **Schemaless** - flexibilní struktura bez pevného schématu
* **Horizontálně škálovatelná** - sharding, replikace
* **Rich query language** - pokročilé dotazování

**Základní koncepty:**

* **Database** - kontejner pro kolekce
* **Collection** - skupina dokumentů (ekvivalent tabulky v SQL)
* **Document** - BSON objekt (ekvivalent řádku v SQL)
* **Field** - klíč-hodnota pár v dokumentu

**Výhody:**

* Flexibilní schéma
* Rychlý vývoj a prototyping
* Nativní podpora pro JSON
* Horizontální škálování
* Rich dokumentový model

**Nevýhody:**

* Nedostatečná ACID podpora (u starších verzí)
* Větší spotřeba paměti
* Složitější konsistence dat

**Použití:** Webové aplikace, real-time analytics, IoT, mobilní aplikace

## Základní operace CRUD

**MongoDB CRUD operace**

**Create (Vytvoření):**

* **insertOne()** - vložení jednoho dokumentu
* **insertMany()** - vložení více dokumentů
* Příklad: `db.users.insertOne({name: \"Jan\", age: 25})`

**Read (Čtení):**

* **find()** - najde dokumenty podle kritérií
* **findOne()** - najde první odpovídající dokument
* **count()** - spočítá dokumenty
* Příklad: `db.users.find({age: {$gte: 18}})`

**Update (Aktualizace):**

* **updateOne()** - aktualizuje první odpovídající dokument
* **updateMany()** - aktualizuje všechny odpovídající dokumenty
* **replaceOne()** - nahradí celý dokument
* Příklad: `db.users.updateOne({name: \"Jan\"}, {$set: {age: 26}})`

**Delete (Smazání):**

* **deleteOne()** - smaže první odpovídající dokument
* **deleteMany()** - smaže všechny odpovídající dokumenty
* Příklad: `db.users.deleteOne({name: \"Jan\"})`

## Pokročilé dotazování

**MongoDB Advanced Querying**

**Comparison operátory:**

* **$eq, $ne** - rovná se, nerovná se
* **$gt, $gte, $lt, $lte** - větší než, menší než
* **$in, $nin** - v seznamu, není v seznamu
* Příklad: `db.products.find({price: {$gte: 100, $lte: 500}})`

**Logical operátory:**

* **$and, $or, $not, $nor** - logické operace
* Příklad: `db.users.find({$or: [{age: {$lt: 18}}, {status: \"premium\"}]})`

**Array operátory:**

* **$all** - všechny prvky musí být přítomné
* **$elemMatch** - alespoň jeden prvek splňuje podmínku
* **$size** - velikost pole

**Text search:**

* **$text** - full-text search
* **$regex** - regulární výrazy

**Projekce a sorting:**

* **projection** - výběr polí: `find({}, {name: 1, age: 1})`
* **sort()** - řazení: `find().sort({age: -1})`
* **limit(), skip()** - stránkování

## Indexování

**MongoDB Indexování**

**Typy indexů:**

* **Single Field Index** - index na jedno pole
* **Compound Index** - index na více polí
* **Multikey Index** - automaticky pro pole (arrays)
* **Text Index** - pro full-text search
* **Geospatial Index** - pro geografická data

**Vytváření indexů:**

* `db.collection.createIndex({field: 1})` - ascending
* `db.collection.createIndex({field: -1})` - descending
* `db.collection.createIndex({name: 1, age: -1})` - compound

**Index vlastnosti:**

* **Unique** - `createIndex({email: 1}, {unique: true})`
* **Partial** - index pouze pro dokumenty splňující podmínku
* **Sparse** - ignoruje dokumenty bez indexovaného pole
* **TTL** - automatické expirování dokumentů

**Správa indexů:**

* `db.collection.getIndexes()` - zobrazí všechny indexy
* `db.collection.dropIndex()` - smaže index
* `db.collection.explain()` - analýza query performance

**Performance tips:**

* Index nejčastěji používaná pole
* Compound indexy - pořadí polí je důležité
* Monitoring pomocí explain()

## Replikace

**MongoDB Replikace**

**Replica Set:**

Skupina MongoDB instancí, které udržují stejnou datovou sadu pro zajištění vysoké dostupnosti a redundance

**Komponenty Replica Set:**

* **Primary** - přijímá všechny write operace
* **Secondary** - kopíruje data z Primary (může obsluhovat read operace)
* **Arbiter** - hlasuje při volbě nového Primary (neuchovává data)

**Automatické failover:**

1. Primary node selže
2. Zbylé uzly hlasují o novém Primary
3. Secondary s nejvyšší prioritou se stává Primary
4. Aplikace pokračuje s minimálním výpadkem

**Read preferences:**

* **primary** - pouze z Primary (default)
* **secondary** - pouze ze Secondary
* **nearest** - z nejbližšího uzlu

**Write concerns:**

* **w: 1** - potvrzení od Primary
* **w: \"majority\"** - potvrzení od majority uzlů
* **j: true** - zápis do journal

**Výhody:**

* Vysoká dostupnost
* Automatické failover
* Read scaling
* Data redundance

## Sharding

**MongoDB Sharding**

**Definice:**

Horizontální škálování databáze rozdělením dat napříč více servery (shardy)

**Komponenty Sharded Cluster:**

* **Shard** - obsahuje podmnožinu dat (replica set)
* **Config servers** - ukládají metadata o distribuci dat
* **mongos** - query router, směruje požadavky na správné shardy

**Shard key:**

Pole nebo kombinace polí, podle kterých se data rozdělují napříč shardy

* Musí být přítomen v každém dokumentu
* Nelze změnit po nastavení
* Ovlivňuje distribuci a performance

**Strategie shardingu:**

* **Range-based** - podle rozsahu hodnot
* **Hash-based** - podle hash hodnoty
* **Zone/Tag-based** - geografické nebo logické rozdělení

**Výhody:**

* Horizontální škálovatelnost
* Zvýšená propustnost
* Geografická distribuce

**Nevýhody:**

* Zvýšená komplexita
* Možné hotspots při špatném shard key
* Složitější správa a monitoring
* Cross-shard operace jsou pomalejší

## Zálohování a obnova

**MongoDB Backup a Recovery**

**Typy zálohování:**

* **mongodump** - logické zálohování do BSON formátu
* **File system backup** - fyzické kopírování datových souborů
* **Replica set backup** - využití secondary uzlů
* **Cloud provider backups** - Atlas, AWS, Azure služby

**mongodump příkazy:**

* `mongodump --db mydb` - backup konkrétní databáze
* `mongodump --collection users --db mydb` - backup kolekce
* `mongodump --host replica-set/host1:27017` - backup z replica set

**mongorestore příkazy:**

* `mongorestore dump/` - obnovení ze zálohy
* `mongorestore --db newdb dump/mydb/` - obnovení do jiné databáze
* `mongorestore --drop` - přepíše existující data

**Strategie zálohování:**

* **Point-in-time recovery** - kombinace backup + oplog
* **Continuous backup** - real-time replikace
* **Scheduled backups** - pravidelné automatické zálohy

**Best practices:**

* Testování obnovení dat
* Geograficky distribuované zálohy
* Kombinace více metod
* Monitoring backup procesů
* Dokumentace recovery procedur

## Agregace a Analytics

**MongoDB Aggregation Pipeline**

**Agregační pipeline:**

Sekvence operací, které transformují dokumenty krok za krokem

**Základní stage operátory:**

* **$match** - filtrování dokumentů (jako WHERE)
* **$project** - výběr a transformace polí
* **$group** - skupinování podle klíče
* **$sort** - řazení výsledků
* **$limit/$skip** - stránkování
* **$unwind** - rozbalení polí typu array

**Agregační operátory:**

* **$sum, $avg, $min, $max** - matematické operace
* **$count** - počet dokumentů
* **$push** - vytvoření pole ze skupiny
* **$first, $last** - první/poslední hodnota

**Praktický příklad:**

`db.orders.aggregate([  
  {$match: {status: \"completed\"}},  
  {$group: {_id: \"$category\", totalSales: {$sum: \"$amount\"}}},  
  {$sort: {totalSales: -1}}  
])`

**Výhody agregace:**

* Výkonné analytické dotazy
* Komplexní transformace dat
* Alternativa k MapReduce
* Nativní podpora v databázi

**Použití:** Reporting, analytics, data transformation, business intelligence
